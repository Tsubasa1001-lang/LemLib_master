# LemLib 馬達相關功能說明

> **專案名稱**: LemLib_1009  
> **版本**: 0.6.0  
> **目標平台**: VEX V5 機器人系統  
> **建立日期**: 2025年11月8日

---

## 1. MotorGroup 核心概念

### 1.1 創建馬達群組

```cpp
// 基本創建
lemlib::MotorGroup motors({1, -2, 3}, 360_rpm);
// 埠號: 1, 2(反轉), 3
// 最大速度: 360 RPM

// 從 PROS MotorGroup 創建
pros::MotorGroup prosGroup({1, -2, 3});
lemlib::MotorGroup motors = lemlib::MotorGroup::from_pros_group(prosGroup, 360_rpm);
```

**參數說明**  
- **埠號列表**: `{1, -2, 3}`，負號代表該馬達預設反轉  
- **輸出速度檔位**: `200_rpm` / `360_rpm` / `600_rpm` (對應 V5 馬達紅、綠、藍齒輪組)

---

## 2. 馬達控制指令

### 2.1 `move()` - 百分比功率
```cpp
int move(Number percent);
```
`percent` 介於 `-1.0 ~ 1.0`，對應 -100% ~ 100% 功率。常見用法：
```cpp
motors.move(0.5);    // 50% 正轉
motors.move(-0.5);   // 50% 反轉
motors.move(0);      // 停止
```

### 2.2 `moveVelocity()` - 角速度模式
```cpp
int moveVelocity(AngularVelocity velocity);
```
支援 `_degps`、`_rpm` 等單位：
```cpp
motors.moveVelocity(50_degps);
motors.moveVelocity(-100_rpm);
```

### 2.3 `brake()` - 依當前煞車模式停止
```cpp
int brake();
```
常搭配 `pros::delay()` 在動作後立即煞停。

### 2.4 `setBrakeMode()` / `getBrakeMode()`
```cpp
int setBrakeMode(BrakeMode mode);
BrakeMode getBrakeMode();
```
可在 `COAST`、`BRAKE`、`HOLD` 之間切換以調整慣性回饋。

---

## 3. 馬達狀態查詢

```cpp
bool connected = motors.isConnected();     // 檢查連線
Angle angle = motors.getAngle();           // 自上次重置以來的角度
motors.setAngle(0_stDeg);                  // 重置角度
AngularVelocity vel = motors.getVelocity();
Temperature temp = motors.getTemperature();
Current current = motors.getCurrent();
```

- `getTemperature()` 回傳群組平均溫度，可用 `to_celsius()` 顯示警示  
- `getCurrent()` 回傳總電流，利於偵測卡死或過載  
- 若 `getAngle()` 回傳 `INFINITY` 代表讀值失敗，通常是接線或初始化問題

---

## 4. 實務範例

### 4.1 完整控制流程

```cpp
void example() {
    lemlib::MotorGroup left_motors({1, 2, 3}, 360_rpm);
    lemlib::MotorGroup right_motors({-8, -9, -10}, 360_rpm);

    left_motors.setBrakeMode(lemlib::BrakeMode::BRAKE);
    right_motors.setBrakeMode(lemlib::BrakeMode::BRAKE);

    if (left_motors.isConnected() && right_motors.isConnected()) {
        left_motors.move(0.8);
        right_motors.move(0.8);
        pros::delay(1000);
        left_motors.brake();
        right_motors.brake();

        Temperature temp = left_motors.getTemperature();
        printf("左側馬達溫度: %.1f°C\n", to_celsius(temp));
    }
}
```

### 4.2 手動控制與監控

```cpp
void opcontrol() {
    pros::Controller controller(pros::E_CONTROLLER_MASTER);

    while (true) {
        int forward = controller.get_analog(pros::E_CONTROLLER_ANALOG_LEFT_Y);
        int turn = controller.get_analog(pros::E_CONTROLLER_ANALOG_RIGHT_X);

        Number left = (forward + turn) / 127.0;
        Number right = (forward - turn) / 127.0;
        left_motors.move(left);
        right_motors.move(right);

        Temperature left_temp = left_motors.getTemperature();
        if (to_celsius(left_temp) > 55.0) {
            pros::lcd::print(5, "WARNING: Left motor hot!");
            left_motors.move(0);
        }

        Current left_current = left_motors.getCurrent();
        Current right_current = right_motors.getCurrent();
        pros::lcd::print(6, "Current: L=%.1fA R=%.1fA",
                        to_amp(left_current),
                        to_amp(right_current));
        pros::delay(20);
    }
}
```

---

## 5. 快速參考與常用數值

### 5.1 指令總覽
| 功能 | 指令 | 範例 |
|------|------|------|
| 按功率移動 | `move(percent)` | `motors.move(0.8)` |
| 按速度移動 | `moveVelocity(vel)` | `motors.moveVelocity(180_degps)` |
| 煞車 | `brake()` | `motors.brake()` |
| 設置煞車模式 | `setBrakeMode(mode)` | `motors.setBrakeMode(BrakeMode::BRAKE)` |
| 獲取角度 | `getAngle()` | `Angle a = motors.getAngle()` |
| 設置角度 | `setAngle(angle)` | `motors.setAngle(0_stDeg)` |
| 獲取溫度 | `getTemperature()` | `Temperature t = motors.getTemperature()` |

### 5.2 常用功率與速度區間
```
功率內部範圍: -1.0 ~ 1.0
PROS 速度值: -127 ~ 127
百分比: -100% ~ 100%

速度參考:
全速: 1.0
高速: 0.8-0.9
中速: 0.5-0.7
低速: 0.3-0.5
最小速度: 0.2-0.3
```

### 5.3 Settling 模式預設
```
進入距離: 7.5 in
最小速度: 0.47
角向輸出: 0
```

---

## 6. 故障排除建議

- 啟動時先呼叫 `isConnected()`，若馬達群組回報未連接立即在 LCD/記錄器警示  
- 透過 `getTemperature()` 和 `getCurrent()` 週期性監控，超標時及時 `move(0)` 降載  
- 在初始化流程中於 IMU 校準與里程計啟動之後設定 `setBrakeMode()`，避免未定義輸出  
- 若需要快速定位問題，可結合 `pros::lcd::print()` 顯示當前功率、溫度與錯誤狀態

---

如需查閱其他模組（感測器或數學工具）的完整內容，請參考 `docs/功能說明文檔.md` 以及對應的拆分文檔。
