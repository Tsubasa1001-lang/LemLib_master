# LemLib 里程計功能

> **專案名稱**: LemLib_1009  
> **版本**: 0.6.0  
> **目標平台**: VEX V5

---

## 1. 模組概述

`lemlib::TrackingWheelOdometry` 透過 IMU 與追蹤輪量測機器人姿態（X、Y、Heading）。建構時可傳入多顆 IMU 以及垂直/水平追蹤輪：

```cpp
lemlib::TrackingWheelOdometry odom(
    {&imu},              // IMU 列表，可多顆
    {&vertical_tracker}, // 垂直追蹤輪列表
    {&horizontal_tracker} // 水平追蹤輪列表
);
```

追蹤輪可使用 Rotation Sensor 或 ADI Encoder，需設定輪徑與偏移量（距離旋轉中心的距離）。

---

## 2. 核心 API

### 2.1 `startTask(Time period = 10_msec)`
啟動背景任務，每 `period` 更新一次姿態。常見流程：IMU 校準完成後立即啟動。

```cpp
imu.calibrate();
pros::delay(3200);
odom.startTask();       // 預設 10ms
// odom.startTask(5_msec);  // 自訂更新週期
```

### 2.2 `stopTask()`
停止背景任務，適合在停車或重新配置感測器前使用。

### 2.3 `setPose(units::Pose pose)`
重置里程計座標。建議在每個自主程序開始前呼叫一次：

```cpp
odom.setPose({0_in, 0_in, 0_cDeg});
```

### 2.4 `getPose() -> units::Pose`
取得目前估測姿態，可用於日誌或顯示。

```cpp
units::Pose pose = odom.getPose();
printf("X: %.2f in, Y: %.2f in, θ: %.2f deg\n",
       to_in(pose.x), to_in(pose.y), to_cDeg(pose.orientation));
```

---

## 3. 常見整合範例

### 3.1 初始化序列

```cpp
void initialize() {
    pros::lcd::initialize();
    imu.calibrate();
    pros::delay(3200);

    odom.startTask();
    odom.setPose({0_in, 0_in, 0_cDeg});
}
```

### 3.2 LCD 即時顯示

```cpp
pros::Task([] {
    while (true) {
        auto p = odom.getPose();
        pros::lcd::print(0, "X: %.2f in", to_in(p.x));
        pros::lcd::print(1, "Y: %.2f in", to_in(p.y));
        pros::lcd::print(2, "θ: %.2f deg", to_cDeg(p.orientation));
        pros::delay(50);
    }
});
```

### 3.3 自主開局

```cpp
void autonomous() {
    odom.setPose({0_in, 0_in, 0_cDeg});
    pros::delay(100);
    lemlib::moveToPoint({24_in, 0_in}, 3_sec, {}, {});
}
```

---

## 4. 使用建議

- **初始化順序**：日誌 → LCD → IMU 校準（等待完成）→ `odom.startTask()` → 其他感測器/任務。未等 IMU 校準完成就啟動里程計會造成姿態偏移。
- **重設姿態**：每次重啟自主或移動到新起點後呼叫 `setPose()`，並留 50–100 ms 讓背景任務穩定。
- **更新頻率**：預設 10 ms 足以應付一般 V5 機器人；若需要更精細軌跡可改為 5 ms，但要注意 CPU 負載。
- **資料監控**：結合 `pros::lcd` 或日誌輸出，可在測試期間快速觀察位置、角度與是否漂移。
- **感測器健康檢查**：初始化前確認追蹤輪編碼器與 IMU 皆 `isConnected()`，以免 startTask 後輸出無效資訊。

---

此文檔專注於里程計相關操作；更多細節與範例可參考 `docs/功能說明文檔.md` 的「里程計系統」章節。***
